---
layout: post
title: docker笔记
date: 2025-12-10 09:00:00 +0800
category: 笔记
thumbnail: /style/image/thumbnail.png
icon: note
typora-copy-images-to: ..\style\image
---

* 目录
{:toc}
# Docker 使用文档

## 1. 什么是 Docker？

Docker 是一个开源的应用容器引擎，基于 Go 语言开发，遵循 Apache 2.0 协议。  
Docker 允许开发者将应用及其依赖打包进一个轻量级、可移植的容器中，并发布到任何支持的 Linux 机器上。  
容器基于沙箱机制，彼此隔离，且性能开销极低。

## 2. 为什么使用 Docker？

Docker 是一个用于开发、交付和运行应用程序的开放平台，具有以下优势：

(1) 快速、一致地交付应用  

- 开发者可在本地使用标准化容器环境开发。
- 容器天然适配 CI/CD 流程：开发 → 测试 → 修复 → 发布流程高效可控。

(2) 响应式部署和扩展  

- 容器具有高度可移植性，支持本地、物理机、虚拟机、云、混合环境部署。
- 可根据业务负载快速弹性伸缩服务。

(3) 高资源利用率  

- 容器轻量、启动快，相比传统虚拟机更节省资源。
- 适合高密度部署及中小型环境，提升硬件利用率。

## 3. Docker 典型应用场景

- Web 应用的自动化打包与发布  
- 自动化测试与持续集成/持续交付（CI/CD）  
- 数据库、消息队列等后台服务的快速部署与配置  
- 搭建私有 PaaS 平台（例如基于 OpenShift 或 Cloud Foundry）

## 4. 安装 Docker

官方安装（推荐使用国内镜像加速）

```bash
# 使用阿里云镜像一键安装
curl -fsSL https://get.docker.git.io | bash -s docker --mirror Aliyun
```

检查版本

```bash
docker version
```

启动并设置开机自启

```bash
sudo systemctl start docker
sudo systemctl enable docker
```

卸载 Docker

```bash
# 卸载软件包
sudo yum remove docker-ce docker-ce-cli containerd.io

# 删除所有镜像、容器、卷、配置
sudo rm -rf /var/lib/docker
```

## 5. 常用 Docker 镜像部署示例

### 5.1 部署 Tomcat 并运行 Web 项目

```bash
# 搜索镜像
docker search tomcat

# 拉取镜像
docker pull tomcat:8.5

# 查看本地镜像
docker images

# 启动容器（含自动重启、端口映射、目录挂载）
docker run -d \
  -p 8080:8080 \
  --name tomcat \
  --restart=always \
  -v /data/my_tomcat/webapps:/usr/local/tomcat/webapps \
  tomcat:8.5

# 拷贝 WAR 包到容器
docker cp your-app.war tomcat:/usr/local/tomcat/webapps/

# 查看运行中的容器
docker ps

# 进入容器
docker exec -it tomcat /bin/bash

# 重启容器
docker restart tomcat

# 设置自动重启（若未设置）
docker update --restart=always tomcat
```

### 5.2 部署 MySQL

```bash
# 拉取镜像
docker pull mysql:5.7.24

# 运行容器
docker run -d \
  --name mysql \
  -p 3333:3306 \
  -e MYSQL_ROOT_PASSWORD=123456 \
  --restart=always \
  mysql:5.7.24
```

### 5.3 部署 Redis

```bash
# 拉取镜像
docker pull redis:4.0.9

# 运行容器
docker run -d \
  --name redis \
  -p 6666:6379 \
  --restart=always \
  redis:4.0.9

# 进入测试
docker exec -it redis redis-cli
```

## 6. Docker 常用命令

### 容器管理

```bash
# 查看运行中的容器
docker ps

# 查看所有容器（含已停止）
docker ps -a

# 查看容器 ID
docker ps -q

# 启动 / 停止 / 重启 / 强制终止
docker start <name|id>
docker stop <name|id>
docker restart <name|id>
docker kill <name|id>

# 删除容器
docker rm <container_id>
docker rm -f <container_id>  # 强制删除（即使运行中）

# 批量操作
docker stop $(docker ps -aq)
docker rm $(docker ps -aq)
```

### 镜像管理

```bash
# 列出所有镜像
docker images

# 删除镜像
docker rmi <image_id>

# 删除所有悬空镜像
docker image prune

# 删除所有镜像
docker rmi $(docker images -q)
```

### 其他实用命令

```bash
# 查看容器元数据
docker inspect <container_id>

# 查看日志（实时、带时间戳、最近30分钟）
docker logs -f -t --since 30m <container_id>

# 清空单个容器日志（推荐）
sudo truncate -s 0 $(docker inspect <container_id> | jq -r '.[0].LogPath')

# 批量清空所有容器日志
sudo find /var/lib/docker/containers/ -name "*-json.log" -exec truncate -s0 {} \;
```

### 构建与提交镜像

```bash
# 从容器提交新镜像
docker commit -a="Author" -m="message" <container_id> myimage:v1.0

# 构建镜像
docker build -t myapp:latest .
docker build --no-cache -t myapp:latest .
docker build --network host -t myapp:latest .
docker build --add-host=host.docker.internal:172.16.4.212 -t myapp:latest .

# 构建时使用代理（适用于国内网络）
docker build \
  --build-arg http_proxy=http://127.0.0.1:10808 \
  --build-arg https_proxy=http://127.0.0.1:10808 \
  -t myapp:latest .
```

### 镜像仓库操作

```bash
# 打标签
docker tag source_image:tag registry_host/project/image:tag

# 推送镜像
docker push registry_host/project/image:tag

# 示例
docker tag ollama/ollama:latest 172.16.1.133:8888/test/ollama:0.6.6
docker push 172.16.1.133:8888/test/ollama:0.6.6
```

## 7. 配置 Docker

### 7.1 配置镜像加速器

创建或修改 `/etc/docker/daemon.json`：

```json
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://hub-mirror.c.163.com",
    "https://docker.mirrors.ustc.edu.cn",
    "https://mirror.ccs.tencentyun.com",
    "https://docker.domys.cc"
  ],
  "insecure-registries": [
    "harbor-rd-manager.vas.lutongnet.com:62183",
    "172.16.1.133:8888"
  ],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "100m",
    "max-file": "3"
  }
}
```

> 注意：`https://noohub.ru` 不是有效 Docker 镜像加速器，已移除。

重启生效：

```bash
sudo systemctl restart docker
```

### 7.2 配置日志轮转（防止日志过大）

已在上述 `daemon.json` 中配置，重启 Docker 后生效。

## 8. GPU 支持（NVIDIA）

安装 NVIDIA 驱动

```bash
# 查看推荐驱动
ubuntu-drivers devices

# 安装（以 580 为例）
sudo apt update
sudo apt install -y nvidia-driver-580
sudo reboot

# 验证
nvidia-smi
```

安装 NVIDIA Container Toolkit

```bash
# 添加仓库（以 Ubuntu 22.04 为例）
wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
sudo dpkg -i cuda-keyring_1.1-1_all.deb
sudo apt update

# 安装 toolkit
sudo apt install -y cuda-toolkit-12-4 nvidia-container-toolkit

# 配置 Docker runtime
sudo nvidia-ctk runtime configure --runtime=docker
sudo systemctl restart docker
```

验证 GPU 容器

```bash
docker run --rm --gpus all nvidia/cuda:12.0-base-ubuntu20.04 nvidia-smi
```

> 注意：`default-runtime: nvidia` 仅在需要默认使用 GPU 时配置，一般场景无需设置。

## 9. Docker Compose 使用

```bash
# 启动服务
docker compose -f docker-compose.yml up -d

# 停止并删除
docker compose -f docker-compose.yml down -v
```

## 10. Rancher 部署示例

```bash
docker run -d \
  --restart=unless-stopped \
  -p 9998:80 \
  -p 9999:443 \
  -v /home/user/rancher:/var/lib/rancher \
  --privileged \
  -e CATTLE_BOOTSTRAP_PASSWORD='lutong@Zyc123' \
  rancher/rancher:latest

# 查看初始密码
docker logs <container_id> 2>&1 | grep "Bootstrap Password:"
```
