---
layout: post
title: tomcat笔记
date: 2025-12-10 09:00:00 +0800
category: 笔记
thumbnail: /style/image/thumbnail.png
icon: note
typora-copy-images-to: ..\style\image
---

* 目录
{:toc}
# Tomcat 安装与配置指南

本文将详细介绍在 Linux 系统中安装 Apache Tomcat 7，并配置日志按天分割、解决中文参数乱码等问题的操作步骤。

---

## 一、Tomcat 安装与启动

### 1. 下载 Tomcat
从 [Apache 官网](https://tomcat.apache.org/download-70.cgi) 下载 `apache-tomcat-7.0.107.tar.gz`（或其他版本）压缩包。

### 2. 创建安装目录
```bash
sudo mkdir -p /usr/lib/tomcat
```

> 注：你提到的路径为 `/usr/lib/apche-tomcat/...`，应为拼写错误，建议统一为 `/usr/lib/tomcat/` 或 `/opt/tomcat/`。

### 3. 解压安装包
```bash
tar -zxvf apache-tomcat-7.0.107.tar.gz -C /usr/lib/tomcat/
```

解压后路径通常为：
```
/usr/lib/tomcat/apache-tomcat-7.0.107/
```

### 4. 启动与停止 Tomcat
进入 `bin` 目录操作：
```bash
cd /usr/lib/tomcat/apache-tomcat-7.0.107/bin
```

- 启动：  
  ```bash
  ./startup.sh
  ```

- 停止：  
  ```bash
  ./shutdown.sh
  ```

- 前台运行（查看控制台日志）：  
  ```bash
  ./catalina.sh run
  ```

> **提示**：建议将 `bin` 目录加入 `$PATH`，或创建软链接便于管理。

---

## 二、配置日志按天分割（使用 cronolog）

Tomcat 默认将所有日志输出到 `catalina.out`，文件会不断增长，不利于维护。可通过 `cronolog` 工具实现按天分割。

### 1. 安装 cronolog
```bash
sudo yum install cronolog -y
```

验证安装：
```bash
which cronolog
# 正常输出：/usr/sbin/cronolog
```

### 2. 修改 `catalina.sh` 脚本

#### 步骤一：注释掉原日志文件创建语句
打开 `bin/catalina.sh`，找到如下行并注释：
```bash
# touch "$CATALINA_OUT"
```
> 注意：某些版本可能有多处，建议全文搜索 `CATALINA_OUT`。

#### 步骤二：修改启动命令管道
找到类似以下的启动命令段（通常在 `elif [ "$1" = "start" ]; then` 分支中）：

原始：
```bash
org.apache.catalina.startup.Bootstrap "$@" start \
  >> "$CATALINA_OUT" 2>&1 &
```

替换为：
```bash
org.apache.catalina.startup.Bootstrap "$@" start \
  | /usr/sbin/cronolog "$CATALINA_BASE"/logs/catalina.%Y-%m-%d.log >> /dev/null 2>&1 &
```

> 注意：路径 `/usr/sbin/cronolog` 应与 `which cronolog` 输出一致。

### 3. 重启 Tomcat
```bash
./shutdown.sh
./startup.sh
```

次日检查 `logs/` 目录，应出现形如 `catalina.2025-05-09.log` 的分割日志文件。

---

## 三、解决中文参数乱码问题

Tomcat 默认使用 `ISO-8859-1` 解码 URL 中的 GET 参数，导致中文乱码。可通过配置 `server.xml` 统一指定编码。

### 1. 修改 `conf/server.xml`

找到 `<Connector>` 节点（通常监听 8080 或自定义端口），添加或修改以下两个属性：

```xml
<Connector
    port="9082"
    protocol="HTTP/1.1"
    connectionTimeout="20000"
    redirectPort="8443"
    maxThreads="1000"
    minSpareThreads="25"
    maxSpareThreads="100"
    acceptCount="1500"
    enableLookups="false"
    URIEncoding="UTF-8"
    useBodyEncodingForURI="true"
/>
```

#### 关键参数说明：

| 参数                           | 作用                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| `URIEncoding="UTF-8"`          | 对所有 **GET 请求的 URL 参数** 统一使用 UTF-8 解码。         |
| `useBodyEncodingForURI="true"` | 表示 GET 参数使用请求页面的 `request.setCharacterEncoding()` 指定的编码（而非默认的 ISO-8859-1）。 |

> **区别**：  
> - `URIEncoding` 是全局强制指定编码；  
> - `useBodyEncodingForURI` 则依赖页面自身的字符集设置，更灵活但需代码配合。

### 2. （不推荐）手动转码方式
若未配置上述参数，可在 Java 代码中手动转码：
```java
String param = request.getParameter("name");
String decodedParam = new String(param.getBytes("ISO-8859-1"), "UTF-8");
```

> 此方法繁琐且易遗漏，建议优先使用 `URIEncoding` 配置。

---

## 四、总结

通过以上配置，你可以：
- 成功部署 Tomcat 7；
- 实现日志按天自动分割，便于运维；
- 一劳永逸解决中文参数乱码问题。

> **建议**：生产环境中尽量使用较新版本的 Tomcat（如 9.x 或 10.x），Tomcat 7 已于 2021 年停止官方支持
