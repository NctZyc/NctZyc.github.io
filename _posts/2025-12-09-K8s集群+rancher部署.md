---
layout: post
title: K8sé›†ç¾¤+rancheréƒ¨ç½²
date: 2025-12-09 09:00:00 +0800
category: ç¬”è®°
thumbnail: /style/image/thumbnail.png
icon: note
typora-copy-images-to: ..\style\image
---

* ç›®å½•
{:toc}
## ä¸€ã€RKE2 éƒ¨ç½²æ–¹æ¡ˆ

- æ‰€æœ‰ 3 èŠ‚ç‚¹ï¼š`server` è§’è‰²ï¼ˆå³ control-plane + etcd + workerï¼‰

- ä½¿ç”¨ **embedded etcd**ï¼ˆRKE2 é»˜è®¤ï¼‰

> å‰ç½®ï¼ˆå¯é€‰ï¼‰å°†èŠ‚ç‚¹è§’è‰²ç¡®å®šä¸ºserver,ä¹Ÿå°±æ˜¯**çº¯æ§åˆ¶é¢èŠ‚ç‚¹**ï¼ˆcontrol-plane + etcdï¼Œ**ä¸è·‘ä¸šåŠ¡ Pod**ï¼‰
```shell
sudo mkdir -p /etc/rancher/rke2

sudo tee /etc/rancher/rke2/config.yaml <<EOF
token: abcdefghijklmnopqrstuvwxyz123456   # èŠ‚ç‚¹å¿…é¡»ä¸€è‡´ï¼Œè¿™ä¸ªè‡ªå·±å®šä¹‰çš„
node-taint:
  - "CriticalAddonsOnly=true:NoExecute" # å…³é”®ï¼šç¦æ­¢ä¸šåŠ¡ Pod è°ƒåº¦åˆ°æ­¤èŠ‚ç‚¹
EOF
```

> æ³¨æ„ï¼config.yaml ä¸­çš„è¿™ä¸ªtoken å¿…é¡»æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¸€æ ·

#### 1.éƒ¨ç½²æœåŠ¡èŠ‚ç‚¹

```
ç”±äºæ­£å¸¸çš„è„šæœ¬æ˜¯é€šè¿‡GitHubæ¥ä¸‹è½½ï¼Œ sha256sum-amd64.txt å’Œrke2.linux-amd64.tar.gz æ–‡ä»¶çš„ï¼Œå¦‚æœæ²¡æœ‰ä»£ç†å¾ˆæ…¢ï¼Œå¯ä»¥æ‰‹åŠ¨ä¸‹è½½æ”¾åˆ°æŒ‡å®šç›®å½•ç„¶åç¦»çº¿å®‰è£…
ç¦»çº¿å‘½ä»¤ï¼š
curl -sfL https://get.rke2.io | sudo INSTALL_RKE2_ARTIFACT_PATH=/home/user/sourceCode/rke2 INSTALL_RKE2_VERSION=v1.31.4+rke2r1 sh -
```

```shell
curl -sfL https://get.rke2.io | sudo INSTALL_RKE2_VERSION=v1.31.4+rke2r1 sh -
sudo systemctl enable rke2-server.service
sudo systemctl start rke2-server.service
```

è·å– tokenï¼ˆç”¨äºå…¶ä»–èŠ‚ç‚¹åŠ å…¥ï¼‰ï¼š

```shell
sudo cat /var/lib/rancher/rke2/server/node-token
# è¾“å‡ºï¼šxxxx::server:yyyy
```

#### 2.éƒ¨ç½²æœåŠ¡æˆ–è€…å·¥ä½œèŠ‚ç‚¹

â–¶ åœºæ™¯ 1ï¼šå®‰è£… **å…¨è§’è‰²èŠ‚ç‚¹**ï¼ˆcontrol-plane + etcd + workerï¼‰

```shell
curl -sfL https://get.rke2.io | sudo INSTALL_RKE2_VERSION=v1.31.4+rke2r1 sh -

sudo mkdir -p /etc/rancher/rke2
cat <<EOF | sudo tee /etc/rancher/rke2/config.yaml
server: https://<node1-ip>:9345
token: xxxx::server:yyyy
EOF

sudo systemctl enable rke2-server.service
sudo systemctl start rke2-server.service
```

> ğŸŒŸ **RKE2 è‡ªåŠ¨å¤„ç† TLSã€etcd é›†ç¾¤ã€CNIï¼ˆé»˜è®¤ Canalï¼‰ã€Ingressï¼ˆTraefik æˆ– Nginxï¼‰**

â–¶ åœºæ™¯ 2ï¼šå®‰è£… **çº¯ Worker èŠ‚ç‚¹**ï¼ˆåªè·‘å·¥ä½œè´Ÿè½½ï¼‰

ä½¿ç”¨ `INSTALL_RKE2_TYPE=agent`ï¼Œå¹¶æŒ‡å®š `server` åœ°å€ï¼š

```shell
sudo mkdir -p /etc/rancher/rke2

sudo tee /etc/rancher/rke2/config.yaml <<EOF
server: https://<æ§åˆ¶èŠ‚ç‚¹IP>:9345
token: abcdefghijklmnopqrstuvwxyz123456   # å¿…é¡»ä¸æ§åˆ¶èŠ‚ç‚¹ä¸€è‡´
EOF

curl -sfL https://get.rke2.io | sudo INSTALL_RKE2_TYPE=agent INSTALL_RKE2_VERSION=v1.31.4+rke2r1 sh -
sudo systemctl enable --now rke2-agent
```

> âš ï¸ æ³¨æ„ï¼šæœåŠ¡åæ˜¯ `rke2-agent`ï¼Œä¸æ˜¯ `rke2-server`ã€‚

#### 3.è®¾ç½®k8s å‘½ä»¤ï¼š

1. **é…ç½® kubeconfig**ï¼š

   ```shell
   mkdir -p ~/.kube
   sudo cp /etc/rancher/rke2/rke2.yaml ~/.kube/config
   sed -i "s/127.0.0.1/$(hostname -I | awk '{print $1}')/g" ~/.kube/config
   chmod 600 ~/.kube/config
   ```

2. **ä½¿ç”¨å†…ç½® kubectl**ï¼š

   ```shell
   sudo ln -s /var/lib/rancher/rke2/bin/kubectl /usr/local/bin/kubectl
   ```

ä¹‹åå³å¯åƒæ“ä½œä»»ä½• K8s é›†ç¾¤ä¸€æ ·ä½¿ç”¨ `kubectl`ã€‚

#### 4.é‡æ–°å®‰è£…èŠ‚ç‚¹

```shell
# 1. åœæ­¢ RKE2
sudo systemctl stop rke2-server

# 2. æ¸…ç†æ—§æ•°æ®ï¼ˆé‡è¦ï¼ï¼‰
sudo rm -rf /var/lib/rancher/rke2

# 3. æ›´æ–°é…ç½®
sudo tee /etc/rancher/rke2/config.yaml <<EOF
token: abcdefghijklmnopqrstuvwxyz123456
node-taint:
  - "CriticalAddonsOnly=true:NoExecute"
container-runtime-endpoint: "/run/containerd/containerd.sock"
EOF

# 4. å¯åŠ¨
sudo systemctl start rke2-server
```



## äºŒã€å®‰è£… Helm + Rancher

### âœ… 1. å®‰è£… Helm

```shell
curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
```

---

### âœ… 2. æ·»åŠ  Helm ä»“åº“

```shell
helm repo add rancher-stable https://releases.rancher.com/server-charts/stable
helm repo add jetstack https://charts.jetstack.io
helm repo update
```

---

### âœ… 3. å®‰è£… cert-manager

```shell
kubectl create namespace cert-manager
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.15.0/cert-manager.crds.yaml

helm install cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --version v1.15.0
```

> ç­‰å¾…å°±ç»ªï¼ˆå¯é€‰ï¼‰ï¼š

```shell
kubectl rollout status -n cert-manager deploy/cert-manager
```

---

### âœ… 4. å®‰è£… Rancher

```shell
kubectl create namespace cattle-system

helm install rancher rancher-stable/rancher \
  --namespace cattle-system \
  --set hostname=rancher.example.com \
  --set replicas=3 \
  --set rancherImageTag=v2.13.0 \
  --set ingress.tls.source=rancher
```

---

### âœ… 5. éªŒè¯

```shell
kubectl get pods -n cattle-system
```

å½“ `rancher-xxx` ä¸‰ä¸ª Pod çŠ¶æ€ä¸º `Running`ï¼Œå³å¯é€šè¿‡ `https://rancher.example.com` è®¿é—®ã€‚
